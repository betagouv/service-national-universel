name: Build and deploy Production

on:
  push:
    branches:
      - 2256_notion_changelog

jobs:

  prepare:
    runs-on: ubuntu-latest

    steps:

      - uses: actions/checkout@v4

      - name: Prepare
        id: prepare
        run : |
          git fetch origin main production

          rc_sha=$(git rev-parse origin/main)
          echo "rc_sha: $rc_sha"
          echo "rc_sha=$rc_sha" >> $GITHUB_OUTPUT

          production_sha=$(git rev-parse origin/production)
          echo "production_sha: $production_sha"
          echo "production_sha=$production_sha" >> $GITHUB_OUTPUT

      - name: Changelog
        id: changelog
        run : |
          echo "<https://github.com/betagouv/service-national-universel/compare/${{ steps.prepare.outputs.production_sha }}...${{ steps.prepare.outputs.rc_sha }}|Release du $(date -Idate)>" > CHANGELOG.md
          git log --pretty="â€¢ %s" "${{ steps.prepare.outputs.production_sha }}...${{ steps.prepare.outputs.rc_sha }}" \
            | grep --invert-match "chore(release): version" \
            | sort \
            | sed 's #\([0-9]*\) <https://github.com/betagouv/service-national-universel/pull/\1|#\1> g' \
            >> CHANGELOG.md
          cat CHANGELOG.md
          {
            echo 'changelog<<EOF'
            cat CHANGELOG.md
            echo EOF
          } >> "$GITHUB_OUTPUT"

      - name: Post Changelog on slack
        uses: slackapi/slack-github-action@v1.25.0
        with:
          channel-id: '#test-rt'
          slack-message: "${{ steps.changelog.outputs.changelog }}"
        env:
          SLACK_BOT_TOKEN: ${{ secrets.SLACK_BOT_TOKEN }}
