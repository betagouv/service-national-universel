name: Test Release Changelog

on:
  push:
    branches:
      - 2214_release_changelog

jobs:
  test:
    runs-on: ubuntu-latest
    outputs:
      main_sha: ${{ steps.prepare.outputs.main_sha }}
      production_sha: ${{ steps.prepare.outputs.production_sha }}

    steps:

    - uses: actions/checkout@v4
      with:
        ref: main
        fetch-depth: 0

    - name: Prepare
      id: prepare
      run : |
        main_sha=$(git rev-parse HEAD)
        echo "main_sha: $main_sha"
        echo "main_sha=$main_sha" >> $GITHUB_OUTPUT

        production_sha=$(git rev-parse origin/production)
        echo "production_sha: $production_sha"
        echo "production_sha=$production_sha" >> $GITHUB_OUTPUT

    - name: "print changelog"
      run : |
        echo "# [$(date -Idate)](https://github.com/betagouv/service-national-universel/compare/${{ steps.prepare.outputs.production_sha }}...${{ steps.prepare.outputs.main_sha }})" > CHANGELOG.md
        git log --pretty="- %s" ${{ steps.prepare.outputs.production_sha }}...${{ steps.prepare.outputs.main_sha }} >> CHANGELOG.md
        cat CHANGELOG.md
