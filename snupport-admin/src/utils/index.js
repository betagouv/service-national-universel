import { STATUS } from "../constants";
import sanitizeHtml from "sanitize-html";
import { useState, useEffect } from "react";
import { ENVIRONMENT } from "../config";

export function classNames(...classes) {
  return classes.filter(Boolean).join(" ");
}

export function urlify(text) {
  var urlRegex = /(https?:\/\/[^\s]+)/g;
  return text.replace(urlRegex, function (url) {
    return ' <a href="' + url + '" target="_blank"> ' + url + " </a> ";
  });
}

export const TRANSLATE_ROLE = {
  ADMIN: "Admin",
  AGENT: "Agent",
  REFERENT_REGION: "R√©f√©rent r√©gional",
  REFERENT_DEPARTMENT: "R√©f√©rent d√©partemental",
};

export const getDocumentTitle = () => {
  let title = "SNUpport";
  switch (ENVIRONMENT) {
    case "development":
      return `${title} (Local)`;
    case "production":
      return title;
    default:
      return `${title} (Test)`;
  }
};

export const getStatusColor = (status) => {
  if (status === STATUS.NEW) return "text-[#C93D38] bg-[#FFDBD9]";
  if (status === STATUS.OPEN) return "text-[#92400E] bg-[#FEF3C7]";
  if (status === STATUS.PENDING) return "text-[#324C71] bg-[#9AD2FF]";
  if (status === STATUS.CLOSED) return "text-[#1F2937] bg-[#D1FAE5]";
  if (status === STATUS.DRAFT) return "text-[#E56717] bg-[#EFB261]";
  if (status === STATUS.TOTREAT) return "text-[#32257F] bg-[#C7D2FE]";
  return ""; // default
};

export const htmlCleaner = (text) => {
  const clean = sanitizeHtml(text, {
    allowedTags: ["b", "i", "em", "strong", "a", "li", "p", "h1", "h2", "h3", "u", "ol", "br", "div", "blockquote", "img"],
    allowedAttributes: {
      a: ["href", "target", "rel"],
      blockquote: ["style"],
      img: ["src", "alt", "style", "width", "height", "iwc-no-src"],
    },
    allowedSchemes: ["data", "http", "https"],
  });
  return sanitizeUrl(clean).trim();
};

const SAFE_URL_PATTERN = /(?:(?:https?|mailto|ftp|tel|file|sms):|[^&:/?#]*(?:[/?#]|$))/gi;

/** A pattern that matches safe data URLs. It only matches image, video, and audio types. */
const DATA_URL_PATTERN = /data:(?:image\/(?:bmp|gif|jpeg|jpg|png|tiff|webp)|video\/(?:mpeg|mp4|ogg|webm)|audio\/(?:mp3|oga|ogg|opus));base64/i;

function sanitizeUrl(url) {
  url = String(url);
  if (!url.includes("data:") && !(url.includes("http:") || url.includes("https:"))) {
    return url;
  }
  if (url.includes("data:") && (url.includes("http:") || url.includes("https:"))) {
    if (url.match(SAFE_URL_PATTERN) && url.match(DATA_URL_PATTERN)) return url;
    else return "";
  }
  if (url.includes("data:")) {
    if (url.match(DATA_URL_PATTERN)) return url;
    else return "";
  }
  if (url.includes("http:") || url.includes("https:")) {
    if (url.match(SAFE_URL_PATTERN)) return url;
    else return "";
  }
}

export function readFileAsync(file) {
  return new Promise((resolve, reject) => {
    let reader = new FileReader();
    reader.onload = () => resolve(reader.result);
    reader.onerror = reject;
    reader.readAsDataURL(file);
  });
}

export const translateState = {
  OPEN: "Ouvert",
  NEW: "Nouveau",
  CLOSED: "Ferm√©",
  PENDING: "En attente",
  DRAFT: "Brouillon",
};

export const translateRole = {
  unknown: "R√¥le inconnu",
  "admin exterior": "Admin non connect√©",
  "young exterior": "Jeune non connect√©",
  responsible: "Responsable structure",
  supervisor: "Superviseur",
  head_center: "Chef de centre",
  head_center_adjoint: "Chef de centre_adjoint",
  referent_sanitaire: "R√©f√©rent sanitaire",
  referent_region: "R√©f√©rent r√©gional",
  referent_department: "R√©f√©rent d√©partemental",
  visitor: "Visiteur",
  young: "Volontaire",
  parent: "Parent",
  admin: "Admin",
  administrateur_cle: "Administrateur CLE",
  referent_classe: "R√©f√©rent Classe",
  transporter: "Transporteur",
  dsnj: "DSNJ",
  injep: "INJEP",
  moderator: "Mod√©rateur",
};

export const translateParcours = {
  CLE: "CLE",
  VOLONTAIRE: "HTS",
};

export function getDotColorClass(contactGroup, parcours) {
  switch (contactGroup) {
    case "young":
      switch (parcours) {
        case "CLE":
          return "bg-pink-500";
        case "VOLONTAIRE":
          return "bg-indigo-500";
        default:
          return "bg-red-100";
      }
    case "administrateur_cle":
    case "referent_classe":
      return "bg-pink-500";
    default:
      return "bg-gray-400";
  }
}

export const roleInitial = {
  unknown: "A",
  "admin exterior": "A",
  "young exterior": "A",
  responsible: "S",
  supervisor: "S",
  head_center: "C",
  head_center_adjoint: "C",
  referent_sanitaire: "C",
  referent_region: "R",
  referent_department: "R",
  visitor: "X",
  young: "V",
  admin: "M",
};

export const translateRoleBDC = {
  admin: "Mod√©rateur",
  referent: "R√©f√©rent",
  structure: "Structure",
  young: "Volontaire HTS",
  young_cle: "Volontaire CLE",
  head_center: "Chef de centre",
  head_center_adjoint: "Chef de centre adjoint",
  referent_sanitaire: "R√©f√©rent sanitaire",
  public: "Public",
  visitor: "Visiteur",
  administrateur_cle_referent_etablissement: "Admin CLE - Chef √©tablissement",
  administrateur_cle_coordinateur_cle: "Admin CLE - Coordinateur",
  referent_classe: "R√©f√©rent Classe",
};

export const translateFeedback = {
  NEUTRAL: "üò∂ Neutre",
  WOW: "üòç WOW",
  THANKS: "üòÅ Merci",
  UNHAPPY: "üòû Ô∏èM√©content",
};

export const translateVentilationOperator = {
  is: "est",
  "is not": "n'est pas",
  smaller: "plus petit",
  greater: "plus grand",
  contains: "contient",
  "not contains": "ne contient pas",
};

export const translateVentilationField = {
  status: "Etat",
  number: "Num√©ro",
  subject: "Titre",
  contactId: "Emetteur",
  agentId: "Agent",
  createdAt: "Cr√©√© le",
  updatedAt: "Mis √† jour √†",
  tags: "Etiquettes",
  textMessage: "Texte",
  lastUpdateAgent: "Mis √† jour par (agent)",
  contactGroup: "Groupe √©metteur",
  contactEmail: "Email √©metteur",
  source: "Source",
  contactDepartment: "Departement",
  contactRegion: "R√©gion",
};

export const translateVentilationFieldAction = {
  status: "Statut",
  agentId: "Agent",
  folder: "Nom d‚Äôun dossier",
  copyRecipient: "Destinataires en copie",
  foldersId: "Dossier",
  tag: "Tag",
};

export const translateSource = {
  CHAT: "Chat",
  MAIL: "Mail",
  PLATFORM: "Plateforme",
  FORM: "Formulaire",
};

export const sourceToIcon = { MAIL: "‚úâÔ∏è", FORM: "üìã", PLATFORM: "üñ•", CHAT: "üí¨" };

export const translateAttributesSNU = (value) => {
  switch (value) {
    case "NONE":
      return "Aucun";
    case "AFFECTED":
      return "Affect√©e";
    case "NOT_DONE":
      return "Non r√©alis√©e";
    case "WAITING_VALIDATION":
      return "En attente de validation";
    case "WAITING_ACCEPTATION":
      return "En attente d'acceptation";
    case "WAITING_VERIFICATION":
      return "En attente de v√©rification d'√©ligibilit√©";
    case "WAITING_AFFECTATION":
      return "En attente d'affectation";
    case "WAITING_CORRECTION":
      return "En attente de correction";
    case "WAITING_UPLOAD":
      return "En attente de t√©l√©versement";
    case "IN_PROGRESS":
      return "En cours";
    case "VALIDATED":
      return "Valid√©e";
    case "DELETED":
      return "Supprim√©e";
    case "WAITING_LIST":
      return "Sur liste compl√©mentaire";
    case "CONTINUOUS":
      return "Mission regroup√©e sur des journ√©es";
    case "DISCONTINUOUS":
      return "Mission r√©partie sur des heures";
    case "AUTONOMOUS":
      return "En autonomie";
    case "DRAFT":
      return "Brouillon";
    case "REFUSED":
      return "Refus√©e";
    case "CANCEL":
      return "Annul√©e";
    case "NOT_ELIGIBLE":
      return "Non √©ligible";
    case "EXEMPTED":
      return "Dispens√©e";
    case "ILLNESS":
      return "Maladie d'un proche ou du volontaire";
    case "DEATH":
      return "Mort d'un proche ou du volontaire";
    case "ADMINISTRATION_CANCEL":
      return "Annulation du s√©jour par l'administration (COVID 19)";
    case "ABANDON":
      return "Abandonn√©e";
    case "ABANDONED":
      return "Inscription Abandonn√©e";
    case "ARCHIVED":
      return "Archiv√©e";
    case "DONE":
      return "Effectu√©e";
    case "WITHDRAWN":
      return "D√©sist√©e";
    case "NOT_COMPLETED":
      return "Non achev√©e";
    case "PRESELECTED":
      return "Pr√©s√©lectionn√©e";
    case "SIGNED_CONTRACT":
      return "Contrat sign√©";
    case "ASSOCIATION":
      return "Association";
    case "PUBLIC":
      return "Structure publique";
    case "PRIVATE":
      return "Structure priv√©e";
    case "GENERAL_SCHOOL":
      return "En enseignement g√©n√©ral ou technologique";
    case "PROFESSIONAL_SCHOOL":
      return "En enseignement professionnel";
    case "AGRICULTURAL_SCHOOL":
      return "En lyc√©e agricole";
    case "SPECIALIZED_SCHOOL":
      return "En √©tablissement sp√©cialis√©";
    case "APPRENTICESHIP":
      return "En apprentissage";
    case "EMPLOYEE":
      return "Salari√©(e)";
    case "INDEPENDANT":
      return "Ind√©pendant(e)";
    case "SELF_EMPLOYED":
      return "Auto-entrepreneur";
    case "ADAPTED_COMPANY":
      return "En ESAT, CAT ou en entreprise adapt√©e";
    case "POLE_EMPLOI":
      return "Inscrit(e) √† P√¥le emploi";
    case "MISSION_LOCALE":
      return "Inscrit(e) √† la Mission locale";
    case "CAP_EMPLOI":
      return "Inscrit(e) √† Cap emploi";
    case "NOTHING":
      return "Inscrit(e) nulle part";
    case "admin":
      return "mod√©rateur";
    case "referent_department":
      return "R√©f√©rent d√©partemental";
    case "referent_region":
      return "R√©f√©rent r√©gional";
    case "responsible":
      return "Responsable";
    case "head_center":
      return "Chef de centre";
    case "head_center_adjoint":
      return "Chef de centre adjoint";
    case "referent_sanitaire":
      return "R√©f√©rent sanitaire";
    case "visitor":
      return "Visiteur";
    case "supervisor":
      return "Superviseur";
    case "manager_department":
      return "Chef de projet d√©partemental";
    case "assistant_manager_department":
      return "Chef de projet d√©partemental adjoint";
    case "manager_department_phase2":
      return "R√©f√©rent d√©partemental phase 2";
    case "manager_phase2":
      return "R√©f√©rent phase 2";
    case "secretariat":
      return "Secr√©tariat";
    case "coordinator":
      return "Coordinateur r√©gional";
    case "assistant_coordinator":
      return "Coordinateur r√©gional adjoint";
    case "recteur_region":
      return "Recteur de r√©gion acad√©mique";
    case "recteur":
      return "Recteur d'acad√©mie";
    case "vice_recteur":
      return "Vice-recteur d'acad√©mie";
    case "dasen":
      return "Directeur acad√©mique des services de l'√©ducation nationale (DASEN)";
    case "sgra":
      return "Secr√©taire g√©n√©ral de r√©gion acad√©mique (SGRA)";
    case "sga":
      return "Secr√©taire g√©n√©ral d'acad√©mie (SGA)";
    case "drajes":
      return "D√©l√©gu√© r√©gional acad√©mique √† la jeunesse, √† l'engagement et aux sports (DRAJES)";
    case "INSCRIPTION":
      return "Inscription";
    case "COHESION_STAY":
      return "S√©jour de coh√©sion";
    case "INTEREST_MISSION":
      return "Mission d'int√©r√™t g√©n√©ral";
    case "CONTINUE":
      return "Poursuivre le SNU";
    case "SUMMER":
      return "Vacances d'√©t√© (juillet ou ao√ªt)";
    case "AUTUMN":
      return "Vacances d'automne";
    case "DECEMBER":
      return "Vacances de fin d'ann√©e (d√©cembre)";
    case "WINTER":
      return "Vacances d'hiver";
    case "SPRING":
      return "Vacances de printemps";
    case "EVENING":
      return "En soir√©e";
    case "END_DAY":
      return "Pendant l'apr√®s-midi";
    case "WEEKEND":
      return "Durant le week-end";
    case "CITIZENSHIP":
      return "Citoyennet√©";
    case "CULTURE":
      return "Culture";
    case "DEFENSE":
      return "D√©fense et m√©moire";
    case "EDUCATION":
      return "√âducation";
    case "ENVIRONMENT":
      return "Environnement";
    case "HEALTH":
      return "Sant√©";
    case "SECURITY":
      return "S√©curit√©";
    case "SOLIDARITY":
      return "Solidarit√©";
    case "SPORT":
      return "Sport";
    case "UNIFORM":
      return "Corps en uniforme";
    case "UNKNOWN":
      return "Non connu pour le moment";
    case "FIREFIGHTER":
      return "Pompiers";
    case "POLICE":
      return "Police";
    case "ARMY":
      return "Militaire";
    case "DURING_HOLIDAYS":
      return "Sur les vacances scolaires";
    case "DURING_SCHOOL":
      return "Sur le temps scolaire";
    case "true":
      return "Oui";
    case "false":
      return "Non";
    case "male":
      return "Homme";
    case "female":
      return "Femme";
    case "father":
      return "P√®re";
    case "mother":
      return "M√®re";
    case "representant":
      return "Repr√©sentant l√©gal";
    case "SERVER_ERROR":
      return "Erreur serveur";
    case "NOT_FOUND":
      return "Ressource introuvable";
    case "PASSWORD_TOKEN_EXPIRED_OR_INVALID":
      return "Lien expir√© ou token invalide";
    case "USER_ALREADY_REGISTERED":
      return "Utilisateur d√©j√† inscrit";
    case "PASSWORD_NOT_VALIDATED":
      return "Votre mot de passe doit contenir au moins 12 caract√®res, dont une majuscule, une minuscule, un chiffre et un symbole";
    case "INVITATION_TOKEN_EXPIRED_OR_INVALID":
      return "Invitation invalide";
    case "USER_NOT_FOUND":
      return "Utilisateur introuvable";
    case "USER_NOT_EXISTS":
      return "L'utilisateur n'existe pas";
    case "OPERATION_UNAUTHORIZED":
      return "Op√©ration non autoris√©e";
    case "FILE_CORRUPTED":
      return "Ce fichier est corrompu";
    case "YOUNG_ALREADY_REGISTERED":
      return "Utilisateur d√©j√† inscrit";
    case "OPERATION_NOT_ALLOWED":
      return "Op√©ration non autoris√©e";
    case "BIKE":
      return "V√©lo";
    case "MOTOR":
      return "Motoris√©";
    case "CARPOOLING":
      return "Covoiturage";
    case "WAITING_REALISATION":
      return "En attente de r√©alisation";
    case "PUBLIC_TRANSPORT":
      return "Transport en commun";
    case "IN_COMING":
      return "√Ä venir";
    case "OTHER":
      return "Autre";
    case "other":
      return "Autre";
    case "SENT":
      return "Envoy√©e";
    case "UNSUPPORTED_TYPE":
      return "Type non pris en charge";
    case "LINKED_OBJECT":
      return "Objet li√©";
    case "NO_TEMPLATE_FOUND":
      return "Template introuvable";
    case "INVALID_BODY":
      return "Requ√™te invalide";
    case "INVALID_PARAMS":
      return "Requ√™te invalide";
    case "EMAIL_OR_PASSWORD_INVALID":
      return "Email ou mot de passe invalide";
    case "PASSWORD_INVALID":
      return "Mot de passe invalide";
    case "EMAIL_INVALID":
      return "Email invalide";
    case "EMAIL_ALREADY_USED":
      return "Cette adresse e-mail est d√©j√† utilis√©e";
    case "EMAIL_AND_PASSWORD_REQUIRED":
      return "Email et mot de passe requis";
    case "PASSWORD_NOT_MATCH":
      return "Les mots de passe ne correspondent pas";
    case "NEW_PASSWORD_IDENTICAL_PASSWORD":
      return "Le nouveau mot de passe est identique √† l'ancien";
    default:
      return value;
  }
};

export const useKeyPress = (targetKey) => {
  const [keyPressed, setKeyPressed] = useState(false);

  useEffect(() => {
    const downHandler = ({ key }) => {
      if (key === targetKey) {
        setKeyPressed(true);
      }
    };

    const upHandler = ({ key }) => {
      if (key === targetKey) {
        setKeyPressed(false);
      }
    };

    window.addEventListener("keydown", downHandler);
    window.addEventListener("keyup", upHandler);

    return () => {
      window.removeEventListener("keydown", downHandler);
      window.removeEventListener("keyup", upHandler);
    };
  }, [targetKey]);

  return keyPressed;
};

export function formatTicketDate(dateString) {
  const creationDate = new Date(dateString);
  return creationDate.toLocaleDateString("fr-FR", {
    day: "2-digit",
    month: "2-digit",
    year: "numeric",
  });
}

export const sortAgents = (specificOrder, a, b) => {
  const indexA = specificOrder.indexOf(a.firstName);
  const indexB = specificOrder.indexOf(b.firstName);

  if (indexA !== -1 || indexB !== -1) {
    if (indexA === -1) return 1;
    if (indexB === -1) return -1;
    return indexA - indexB;
  }

  return a.firstName.localeCompare(b.firstName);
};

export function filterObjectByKeys(sourceObject, allowedKeys, options = { dropEmptyValue: false }) {
  const result = {};
  for (let key of allowedKeys) {
    if (key in sourceObject) {
      const value = sourceObject[key];
      if (options.dropEmptyValue) {
        if (!(value === "" || (Array.isArray(value) && value.length === 0))) {
          result[key] = value;
        }
      } else {
        result[key] = value;
      }
    }
  }
  return result;
}
export function normalizeString(str) {
  return str
    .toUpperCase()
    .normalize("NFD")
    .replace(/[\u0300-\u036f]/g, "")
    .replace(/-/g, " ")
    .replace(/'/g, "")
    .replace(/\s+/g, " ")
    .trim();
}

export * from "./cohort.utils";
export * from "./date";
export * from "./dayjs.utils";
export * from "./region-and-departments.utils";
export * from "./searchParams.utils";
